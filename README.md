# Generation of SNP Matrix from Genomic Data
This repository aims to generate a SNP matrix from genomic data obtained via *target-enrichment sequencing* using the Cactaceae591 panel (Romeiro-Brito et al. 2022). The required programs and commands should be executed on a Linux operating system (or the Linux Subsystem for Windows) through the Bash interface. This tutorial assumes that you already have your genomic data trimmed and assembled into their respective loci. For more details, please refer to [Genomic Data Processing and Phylogenetic Inferences](https://github.com/juvicat/Genomic-data-processing-and-phylogenetic-inferences.git) 1 and 2.

Repository Base: The *scripts* used were adapted from the repository [HybSeq-SNP-Extraction](https://github.com/lindsawi/HybSeq-SNP-Extraction.git), published by Madeline Slimp and Matthew Johnson. The processes described here were adopted in the scientific initiation project "Multilocus Phylogeny of *Arrojadoa* Britton & Rose, a cactus endemic to eastern Brazil," developed under the guidance of Professor Dr. Evandro M. Moraes at the Laboratory of Genetic Diversity and Evolution (LaGEvol, UFSCar Sorocaba campus).

## Organizing Input Files
With the sequences assembled into their respective loci by *Hybpiper*, you can remove paralogous loci if they have been identified. You can create a list file with the names of these loci (`paralogs_list.txt`) and move them to a separate folder (`paralogs`):
```
mkdir paralogs while read -r paralog_locus; do mv "$paralog_locus" paralogs/; done < paralogs_list.txt
```
The SNPs will be called from the longest sequence recovered for each locus, represented by a `.fasta` file stored in the folders with the `supercontig.fasta` suffix. You can copy these files into a single folder:
```
mkdir supercontigs cp sample_name/{OG,phyc,ppc}/sample_name/sequences/intron/_supercontig.fasta /supercontigs
```

The sequence names in the `.fasta` files need to be standardized with the name of their respective locus:
```
for i in *.fas; do awk '{if( NR==1)print ">"FILENAME;else print}' "$i" > "$i.fasta"; done
```

## Assembling the Reference File
A reference file is necessary to align the sequences before extracting SNPs, and you can use the sequences from a sample for this purpose. It is recommended to choose the sample based on statistics generated during the locus assembly, such as the sample with the fewest missing loci or with loci containing the highest number of base pairs.

You can also add loci that are missing from your reference file, using samples that have these loci. To do this, create a list with the names of all available loci for your sampling (`loci_list.txt`) and use the `verifiyng_loci.sh` script to detect the missing loci:
```
bash verifiyng_loci.sh
```

This script generates a list of missing loci, which can be used to copy these loci from other samples. This addition can be done manually or using the `move_missing_locci.txt` script, which will copy the locus from the first sample found that contains it:
```
bash move_missing_locci.txt
```

Once all loci for the reference are gathered, they need to be concatenated into a single file:
```
cat *_supercontig.fasta > reference.cat_supercontigs.fasta
```
## SNP Calling
For variant calling (SNPs and indels), we will use GATK (https://github.com/broadinstitute/gatk.git). Initially, we will use the `variant_call.sh` script to generate a GVCF file for each species worked on. This script needs to be adapted for the environment in which it will be run, following the instructions in the file.

For species with a single sample:
```
bash variant_call.sh reference.cat_supercontigs.fasta species_name
```
For species with more than one sample (the *nohup* flag runs the script in the background):
```
nohup bash variant_call.sh reference.cat_supercontigs.fasta species_name &> variantcall.log &
```
The `gather_GVCFs.sh` script is used to merge the GVCF files and perform an initial SNP filtering, as well as remove other types of variants:
```
bash gather_GVCFs.sh reference.cat_supercontigs.fasta taxon_name
```

The outputs generated by this script will be: `taxon_name.SNPall.gvcf` (contains all SNPs and indels), `taxon_name.snp.filtered.gvcf` (contains only SNPs, no indels), and `taxon_name.snp.filtered.nocall.gvcf` (only SNPs that passed the filter).

## SNP Filtering
It is recommended to apply a second filtering to the SNP matrix using the *plink* program (https://github.com/insilico/plink.git). Parameters for linkage disequilibrium (`--indep`) and percentage of missing data (`--geno`) can be set by editing the `plink_filtering.sh` script:
```
bash plink_filtering.sh taxon_name
```

Finally, the same program is used to generate a VCF file from the output files of the script:
```
plink --allow-extra-chr --bfile taxon_name_pruned --recode vcf --out taxon_name_pruned_vcf
```
